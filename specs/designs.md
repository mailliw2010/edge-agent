# 系统设计文档

本文档详细描述了 "Edge Agent" 项目的关键架构和模块设计。

## 1. 核心架构

项目采用基于 LangChain Agent 的核心架构，通过 FastAPI 将 Agent 的能力以 RESTful API 的形式暴露给外部。

- **Agent (`agents/`)**: 定义了 Agent 的核心逻辑、可使用的工具 (Tools) 和提示 (Prompts)。
- **工具 (`tools/`)**: 实现了 Agent 可以调用的具体功能，例如读取传感器、控制设备等。
- **API 服务 (`api/server.py`)**: 使用 FastAPI 构建的 Web 服务，负责接收外部请求，调用 Agent，并返回结果。采用单例模式管理 Agent 实例，确保高效响应。
- **LLM 工厂 (`core/llm_factory.py`)**: 负责根据配置动态创建和管理与不同大语言模型（如 Tongyi Qwen, vLLM）的连接。

## 2. 日志架构设计

为了满足生产环境的可观测性、可追溯性和易于调试的需求，项目采用 `Loguru` 库构建了一套强大且灵活的日志系统。

### 2.1 设计原则

- **结构化日志**: 在生产环境中，所有日志都以 JSON 格式输出，便于日志收集系统（如 ELK, Splunk, Datadog）的解析和索引。
- **环境感知**: 日志系统能够根据环境变量自动切换格式。开发环境输出人类可读的彩色文本，生产环境输出机器可读的 JSON。
- **集中配置**: 所有日志相关的配置都集中在 `core/log_config.py` 模块中，便于统一管理和修改。
- **标准库兼容**: 系统能无缝接管并重定向 Python 内置 `logging` 模块以及所有使用它的第三方库（如 Uvicorn, LangChain）的日志输出，确保日志格式的完全统一。
- **高性能**: 采用异步、队列等机制 (`enqueue=True`) 确保日志写入不会阻塞主应用线程。

### 2.2 实现细节

- **主要库**: `loguru`
- **配置文件**: `.env`
- **核心模块**: `core/log_config.py`

#### 配置方式

通过在 `.env` 文件中设置以下环境变量来控制日志行为：

- `LOG_FORMAT`: 日志格式。
  - `"text"` (默认): 用于本地开发，输出带颜色的文本格式。
  - `"json"`: 用于生产环境，输出 JSON 格式。
- `LOG_LEVEL`: 日志级别，如 `INFO`, `DEBUG`, `WARNING`。
- `LOG_FILE`: （可选）指定日志输出的文件路径。如果设置，日志会同时输出到控制台和文件。该功能支持日志文件的自动轮转、压缩和保留策略。

#### 配置加载

- **本地开发**: 为了方便开发者，项目在 `api/server.py` 的入口处使用 `python-dotenv` 库的 `load_dotenv()` 函数自动加载 `.env` 文件。
- **容器化生产环境**: 在 Docker 或 Kubernetes 环境中，应通过容器运行时直接注入环境变量。`load_dotenv()` 在找不到 `.env` 文件时会静默失败，应用将直接使用由容器环境提供的变量，实现了开发与生产的无缝衔接。
